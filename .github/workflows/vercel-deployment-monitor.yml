name: Vercel Deployment Monitor

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/15 * * * *'  # Check every 15 minutes

jobs:
  check-deployment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check Vercel Deployment Status
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          # Get latest deployment status
          DEPLOYMENT_DATA=$(curl -s -H "Authorization: Bearer $VERCEL_TOKEN" \
            "https://api.vercel.com/v6/deployments?projectId=$VERCEL_PROJECT_ID&limit=1")
          
          DEPLOYMENT_STATE=$(echo $DEPLOYMENT_DATA | grep -o '"state":"[^"]*' | cut -d'"' -f4)
          DEPLOYMENT_URL=$(echo $DEPLOYMENT_DATA | grep -o '"url":"[^"]*' | cut -d'"' -f4 | head -1)
          DEPLOYMENT_ID=$(echo $DEPLOYMENT_DATA | grep -o '"uid":"[^"]*' | cut -d'"' -f4 | head -1)
          
          echo "Latest Deployment State: $DEPLOYMENT_STATE"
          echo "Deployment URL: https://$DEPLOYMENT_URL"
          echo "Deployment ID: $DEPLOYMENT_ID"
          
          # Log to GitHub Actions
          echo "deployment_state=$DEPLOYMENT_STATE" >> $GITHUB_ENV
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_ENV
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_ENV
      
      - name: Comment on PR with Deployment Info
        if: github.event_name == 'push'
        uses: actions/github-script@v6
        with:
          script: |
            const deploymentUrl = process.env.deployment_url;
            const deploymentState = process.env.deployment_state;
            const deploymentId = process.env.deployment_id;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `\u23F3 **Vercel Deployment Monitor**\n\nDeployment State: \`${deploymentState}\`\nURL: https://${deploymentUrl}\nID: ${deploymentId}`
            });
        env:
          deployment_state: ${{ env.deployment_state }}
          deployment_url: ${{ env.deployment_url }}
          deployment_id: ${{ env.deployment_id }}
